<!DOCTYPE html>
<html lang="zh-CN">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="robots" content="noodp" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge, chrome=1">
        <title>插件化基础（简单调起 Activity） - 北邙山之光的 Blog</title><meta name="Description" content=""><meta property="og:title" content="插件化基础（简单调起 Activity）" />
<meta property="og:description" content="插件化这个知识我觉得是 Android 开发必修课，但是一直没有了解
虽然 github 上开源的插件化方案层出不穷，但是因为他们实在太强大，加上我这方面基础不行，不是很能看的懂！！
这里也希望自己以后可以回过头去再去研究一下 Virtual Apk 这种插件化开源代码。" />
<meta property="og:type" content="article" />
<meta property="og:url" content="http://PTrain666.github.io/posts/2017-10-18-%E6%8F%92%E4%BB%B6%E5%8C%96%E5%9F%BA%E7%A1%80-%E7%AE%80%E5%8D%95%E8%B0%83%E8%B5%B7-Activity/" /><meta property="og:image" content="http://PTrain666.github.io/logo.png"/><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2017-10-18T00:00:00&#43;00:00" />
<meta property="article:modified_time" content="2017-10-18T00:00:00&#43;00:00" />

<meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content="http://PTrain666.github.io/logo.png"/>

<meta name="twitter:title" content="插件化基础（简单调起 Activity）"/>
<meta name="twitter:description" content="插件化这个知识我觉得是 Android 开发必修课，但是一直没有了解
虽然 github 上开源的插件化方案层出不穷，但是因为他们实在太强大，加上我这方面基础不行，不是很能看的懂！！
这里也希望自己以后可以回过头去再去研究一下 Virtual Apk 这种插件化开源代码。"/>
<meta name="application-name" content="北邙山之光的 Blog">
<meta name="apple-mobile-web-app-title" content="北邙山之光的 Blog"><link rel="icon" href="/img/favicon.ico"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="canonical" href="http://PTrain666.github.io/posts/2017-10-18-%E6%8F%92%E4%BB%B6%E5%8C%96%E5%9F%BA%E7%A1%80-%E7%AE%80%E5%8D%95%E8%B0%83%E8%B5%B7-Activity/" /><link rel="prev" href="http://PTrain666.github.io/posts/2017-09-26-Android-7.0-%E6%8A%93%E5%8C%85%E9%97%AE%E9%A2%98/" /><link rel="next" href="http://PTrain666.github.io/posts/2017-10-26-Activity-%E5%90%AF%E5%8A%A8%E8%BF%87%E7%A8%8B/" /><link rel="stylesheet" href="/lib/normalize/normalize.min.css"><link rel="stylesheet" href="/css/style.min.css"><link rel="stylesheet" href="/lib/fontawesome-free/all.min.css"><link rel="stylesheet" href="/lib/animate/animate.min.css"><script type="application/ld+json">
    {
        "@context": "http://schema.org",
        "@type": "BlogPosting",
        "headline": "插件化基础（简单调起 Activity）",
        "inLanguage": "zh-CN",
        "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": "http:\/\/PTrain666.github.io\/posts\/2017-10-18-%E6%8F%92%E4%BB%B6%E5%8C%96%E5%9F%BA%E7%A1%80-%E7%AE%80%E5%8D%95%E8%B0%83%E8%B5%B7-Activity\/"
        },"genre": "posts","keywords": "插件化","wordcount":  2213 ,
        "url": "http:\/\/PTrain666.github.io\/posts\/2017-10-18-%E6%8F%92%E4%BB%B6%E5%8C%96%E5%9F%BA%E7%A1%80-%E7%AE%80%E5%8D%95%E8%B0%83%E8%B5%B7-Activity\/","datePublished": "2017-10-18T00:00:00+00:00","dateModified": "2017-10-18T00:00:00+00:00","publisher": {
            "@type": "Organization",
            "name": "北邙山之光"},"author": {
                "@type": "Person",
                "name": "北邙山之光"
            },"description": ""
    }
    </script><script data-ad-client="ca-pub-4814124987641317" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
    </head>
    <body header-desktop="fixed" header-mobile="auto"><script type="text/javascript">(window.localStorage && localStorage.getItem('theme') ? localStorage.getItem('theme') === 'dark' : ('light' === 'auto' ? window.matchMedia('(prefers-color-scheme: dark)').matches : 'light' === 'dark')) && document.body.setAttribute('theme', 'dark');</script>

        <div id="mask"></div><div class="wrapper"><header class="desktop" id="header-desktop">
    <div class="header-wrapper">
        <div class="header-title">
            <a href="/" title="北邙山之光的 Blog"><span class="header-title-pre"><i class='far fa-dizzy'></i></span><span id="id-1" class="typeit"></span></a>
        </div>
        <div class="menu">
            <div class="menu-inner"><a class="menu-item" href="/posts/"> 文章 </a><a class="menu-item" href="/tags/"> 标签 </a><a class="menu-item" href="/about/"> 关于 </a><a class="menu-item" href="https://github.com/PTrain666" title="GitHub" rel="noopener noreffer" target="_blank"><i class='fab fa-github fa-fw'></i>  </a><span class="menu-item delimiter"></span><span class="menu-item search" id="search-desktop">
                        <input type="text" placeholder="搜索文章标题或内容..." id="search-input-desktop">
                        <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-desktop" title="搜索">
                            <i class="fas fa-search fa-fw"></i>
                        </a>
                        <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-desktop" title="清空">
                            <i class="fas fa-times-circle fa-fw"></i>
                        </a>
                        <span class="search-button search-loading" id="search-loading-desktop">
                            <i class="fas fa-spinner fa-fw fa-spin"></i>
                        </span>
                    </span><a href="javascript:void(0);" class="menu-item theme-switch" title="切换主题">
                    <i class="fas fa-adjust fa-fw"></i>
                </a>
            </div>
        </div>
    </div>
</header><header class="mobile" id="header-mobile">
    <div class="header-container">
        <div class="header-wrapper">
            <div class="header-title">
                <a href="/" title="北邙山之光的 Blog"><span class="header-title-pre"><i class='far fa-dizzy'></i></span><span id="id-2" class="typeit"></span></a>
            </div>
            <div class="menu-toggle" id="menu-toggle-mobile">
                <span></span><span></span><span></span>
            </div>
        </div>
        <div class="menu" id="menu-mobile"><div class="search-wrapper">
                    <div class="search mobile" id="search-mobile">
                        <input type="text" placeholder="搜索文章标题或内容..." id="search-input-mobile">
                        <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-mobile" title="搜索">
                            <i class="fas fa-search fa-fw"></i>
                        </a>
                        <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-mobile" title="清空">
                            <i class="fas fa-times-circle fa-fw"></i>
                        </a>
                        <span class="search-button search-loading" id="search-loading-mobile">
                            <i class="fas fa-spinner fa-fw fa-spin"></i>
                        </span>
                    </div>
                    <a href="javascript:void(0);" class="search-cancel" id="search-cancel-mobile">
                        取消
                    </a>
                </div><a class="menu-item" href="/posts/" title="">文章</a><a class="menu-item" href="/tags/" title="">标签</a><a class="menu-item" href="/about/" title="">关于</a><a class="menu-item" href="https://github.com/PTrain666" title="GitHub" rel="noopener noreffer" target="_blank"><i class='fab fa-github fa-fw'></i></a><a href="javascript:void(0);" class="menu-item theme-switch" title="切换主题">
                <i class="fas fa-adjust fa-fw"></i>
            </a></div>
    </div>
</header>
<div class="search-dropdown desktop">
    <div id="search-dropdown-desktop"></div>
</div>
<div class="search-dropdown mobile">
    <div id="search-dropdown-mobile"></div>
</div>
<main class="main">
                <div class="container"><div class="toc" id="toc-auto">
            <h2 class="toc-title">目录</h2>
            <div class="toc-content" id="toc-content-auto"></div>
        </div><article class="page single"><h1 class="single-title animated flipInX">插件化基础（简单调起 Activity）</h1><div class="post-meta">
            <div class="post-meta-line"><span class="post-author"><a href="/" title="Author" rel=" author" class="author"><i class="fas fa-user-circle fa-fw"></i>北邙山之光</a></span></div>
            <div class="post-meta-line"><i class="far fa-calendar-alt fa-fw"></i>&nbsp;<time datetime="2017-10-18">2017-10-18</time>&nbsp;<i class="fas fa-pencil-alt fa-fw"></i>&nbsp;约 2213 字&nbsp;
                <i class="far fa-clock fa-fw"></i>&nbsp;预计阅读 5 分钟&nbsp;
            </div>
        </div><div class="details toc" id="toc-static"  kept="">
                <div class="details-summary toc-title">
                    <span>目录</span>
                    <span><i class="details-icon fas fa-angle-right"></i></span>
                </div>
                <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li><a href="#核心思想">核心思想</a>
      <ul>
        <li></li>
      </ul>
    </li>
    <li><a href="#具体实现">具体实现</a></li>
    <li><a href="#资源问题还没有解决">资源问题还没有解决</a></li>
    <li><a href="#学习目标">学习目标</a></li>
    <li><a href="#参考">参考</a></li>
  </ul>
</nav></div>
            </div><div class="content" id="content"><p>插件化这个知识我觉得是 Android 开发必修课，但是一直没有了解</p>
<p>虽然 github 上开源的插件化方案层出不穷，但是因为他们实在太强大，加上我这方面基础不行，不是很能看的懂！！</p>
<p>这里也希望自己以后可以回过头去再去研究一下 Virtual Apk 这种插件化开源代码。</p>
<h2 id="核心思想">核心思想</h2>
<p>如果我们只是单纯的想从一个 apk 调用到另一个 apk 的代码的话，其实只要能把那个 apk 加载进来就好了</p>
<p>这里各种框架可能有各种相应的方法</p>
<p>我这里知道的一种方式：</p>
<p>我们就是需要一个 Classloader，android 中就是 pathclassloader 和 dexclassloader，pathclassloader 是用来加载系统类的，dexclassloader 用于加载其他 dex 文件中的类，他们都继承自 BaseDexClassloader
我们可以创建一个 DexClassLoader</p>
<h4 id="为什么要构建一个-classloader">为什么要构建一个 ClassLoader</h4>
<p>我们首先需要把我们插件的 apk 加载进来，并且形成一种其他 classloader 可以认识的形式，就是 BaseDexClassLoader 中的 pathlist 变量这种形式，这个 pathlist 是一个 DexPathList 类型，而 DexPathList 中又有一个成员变量 dexElements，是一个数组形式，其实就是我们加载我们的 dex 的地方，那么我们只要把宿主的和插件的这两个数组合成一个就可以了。这时候我们已经可以调用插件 apk 的普通方法了!</p>
<h4 id="和加载一个-activity-有什么不同">和加载一个 activity 有什么不同？</h4>
<p>我们只要把插件 apk 的 dex 和宿主 apk 的 dex 两个数组整合在一起，这时候我们已经可以调用插件里面的一些方法了，但是我们还是不能启动插件的 Activity，因为四大组件是需要注册的，需要 hook 一下 AMS。</p>
<p>我们一般启动一个 activity 就是一个 Intent，然后 startActivity，但是我们 Intent 中设置的是插件中的 Activiy,在宿主的 manifest 中并没有被注册，也就不可能被调用。但是我们可以注册一个空的 Activity 放着不用，当我们要调用插件的 Activity 的时候，我们可以通过这个空的 Activity 来绕过 AMS。所以我们需要 hook 一下 AMS,拿到 Intent，然后再 new 一个 Intent,新的 Intent 是指向我们占坑的空的 Acitivity ,然后把老的 Intent 保存在新的 Intent 中。</p>
<p>这样还不行，因为如果这样做，虽然我们可以启动 Activity 了，但是启动的是宿主 apk 里面的一个占坑的 Activity，而不是我们插件的 Acitivity。</p>
<p>所以还需要 hook一下真正处理 launchActivity 的地方，这个方法最后是调用到 Handler 中的，所以我们这里可以修改的 handler 的处理细节的话也就成了。</p>
<p>这中间涉及到 handler 的一些源码，我们需要给 handler 的 mCallback 属性赋值，从而让它可以在 handleMessage（也就是启动 activity）之前换回我们的插件的 intent。</p>
<p>完成！</p>
<h2 id="具体实现">具体实现</h2>
<ul>
<li>
<p>加载插件 apk</p>
<ul>
<li>创建一个 DexClassLoader</li>
</ul>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="n">String</span> <span class="n">apkPath</span> <span class="o">=</span> <span class="n">Environment</span><span class="o">.</span><span class="na">getExternalStorageDirectory</span><span class="o">().</span><span class="na">getAbsolutePath</span><span class="o">()+</span><span class="s">&#34;/test.apk&#34;</span><span class="o">;</span>
<span class="n">String</span> <span class="n">cachePath</span> <span class="o">=</span> <span class="n">MainActivity</span><span class="o">.</span><span class="na">this</span><span class="o">.</span><span class="na">getCacheDir</span><span class="o">().</span><span class="na">getAbsolutePath</span><span class="o">();</span>
<span class="n">DexClassLoader</span> <span class="n">mClassLoader</span> <span class="o">=</span> <span class="k">new</span> <span class="n">DexClassLoader</span><span class="o">(</span><span class="n">apkPath</span><span class="o">,</span><span class="n">cachePath</span><span class="o">,</span><span class="n">cachePath</span><span class="o">,</span><span class="n">getClassLoader</span><span class="o">());</span>
</code></pre></div><ul>
<li>整合两个dex</li>
</ul>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span>  <span class="kd">static</span>  <span class="kt">void</span> <span class="nf">hook</span><span class="o">(</span><span class="n">DexClassLoader</span> <span class="n">classLoader</span><span class="o">){</span>
    <span class="n">PathClassLoader</span> <span class="n">pathClassLoader</span> <span class="o">=</span> <span class="o">(</span><span class="n">PathClassLoader</span><span class="o">)</span> <span class="n">MyApplication</span><span class="o">.</span><span class="na">getContext</span><span class="o">().</span><span class="na">getClassLoader</span><span class="o">();</span>
    <span class="k">try</span> <span class="o">{</span>
        <span class="c1">//反射获取宿主apk的pathlist
</span><span class="c1"></span>        <span class="n">Object</span> <span class="n">mainPathList</span> <span class="o">=</span> <span class="n">getPathList</span><span class="o">(</span><span class="n">pathClassLoader</span><span class="o">);</span>
        <span class="c1">//这里的classloder是前面创建的DexClassLoader
</span><span class="c1"></span>        <span class="c1">//同样获取到插件apk的pathlist
</span><span class="c1"></span>        <span class="n">Object</span> <span class="n">mPathList</span> <span class="o">=</span> <span class="n">getPathList</span><span class="o">(</span><span class="n">classLoader</span><span class="o">);</span>

        <span class="cm">/**
</span><span class="cm">        * 合并两个dex，两个dex也是通过反射获取的
</span><span class="cm">        * 获取dexElements：
</span><span class="cm">        * Class clazz = PathList.getClass();
</span><span class="cm">        * Field field = clazz.getDeclaredField(&#34;dexElements&#34;);
</span><span class="cm">        * field.setAccessible(true);
</span><span class="cm">        * return field.get(PathList);
</span><span class="cm">        * 合并dexElements：
</span><span class="cm">        * 获取到两个dexElements的数组类型
</span><span class="cm">        * Class&lt;?&gt; localClass = suzhu.getClass().getComponentType();
</span><span class="cm">        * 创建一个长度是两个dexElements之和的相应类型的数组
</span><span class="cm">        * Object result = Array.newInstance(localClass, new_arr_length);
</span><span class="cm">
</span><span class="cm">        * setField(suZhuPathList, suZhuPathList.getClass(), &#34;dexElements&#34;, dexElements);
</span><span class="cm">        */</span>
        <span class="n">Object</span> <span class="n">dexElements</span> <span class="o">=</span> <span class="n">combineArray</span><span class="o">(</span>
                <span class="n">getDexElements</span><span class="o">(</span><span class="n">mainPathList</span><span class="o">),</span>
                <span class="n">getDexElements</span><span class="o">(</span><span class="n">mPathList</span><span class="o">));</span>
        <span class="c1">// 反射,把之前的dexElements替换成我们新合成的dexElements
</span><span class="c1"></span>        <span class="n">Field</span> <span class="n">localField</span> <span class="o">=</span> <span class="n">mainPathList</span><span class="o">.</span><span class="na">getClass</span><span class="o">().</span><span class="na">getDeclaredField</span><span class="o">(</span><span class="s">&#34;dexElements&#34;</span><span class="o">);</span>
        <span class="n">localField</span><span class="o">.</span><span class="na">setAccessible</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
        <span class="n">localField</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="n">mainPathList</span><span class="o">,</span><span class="n">dexElements</span><span class="o">);</span>
    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></li>
<li>
<p>绕过AMS检查</p>
<ul>
<li>
<p>hookAMS</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">private</span> <span class="kt">void</span> <span class="nf">AmsHook</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">ClassNotFoundException</span><span class="o">,</span> <span class="n">NoSuchFieldException</span><span class="o">,</span> <span class="n">IllegalAccessException</span> <span class="o">{</span>
    <span class="n">Class</span> <span class="n">ActivityManagerNative</span> <span class="o">=</span> <span class="n">Class</span><span class="o">.</span><span class="na">forName</span><span class="o">(</span><span class="s">&#34;android.app.ActivityManagerNative&#34;</span><span class="o">);</span>
    <span class="n">Field</span> <span class="n">gDefaultField</span> <span class="o">=</span> <span class="n">ActivityManagerNative</span><span class="o">.</span><span class="na">getDeclaredField</span><span class="o">(</span><span class="s">&#34;gDefault&#34;</span><span class="o">);</span>
    <span class="n">gDefaultField</span><span class="o">.</span><span class="na">setAccessible</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
    <span class="n">Object</span> <span class="n">gDefault</span> <span class="o">=</span> <span class="n">gDefaultField</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="kc">null</span><span class="o">);</span>

    <span class="n">Class</span> <span class="n">Singleton</span> <span class="o">=</span> <span class="n">Class</span><span class="o">.</span><span class="na">forName</span><span class="o">(</span><span class="s">&#34;android.util.Singleton&#34;</span><span class="o">);</span>
    <span class="n">Field</span> <span class="n">mInstanceField</span> <span class="o">=</span> <span class="n">Singleton</span><span class="o">.</span><span class="na">getDeclaredField</span><span class="o">(</span><span class="s">&#34;mInstance&#34;</span><span class="o">);</span>
    <span class="n">mInstanceField</span><span class="o">.</span><span class="na">setAccessible</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
    <span class="n">Object</span> <span class="n">obj</span> <span class="o">=</span> <span class="n">mInstanceField</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">gDefault</span><span class="o">);</span>

    <span class="n">Class</span> <span class="n">IActivityManager</span> <span class="o">=</span> <span class="n">Class</span><span class="o">.</span><span class="na">forName</span><span class="o">(</span><span class="s">&#34;android.app.IActivityManager&#34;</span><span class="o">);</span>
    <span class="n">Object</span> <span class="n">proxy</span> <span class="o">=</span> <span class="n">Proxy</span><span class="o">.</span><span class="na">newProxyInstance</span><span class="o">(</span><span class="n">getClassLoader</span><span class="o">(),</span> <span class="k">new</span> <span class="n">Class</span><span class="o">[]{</span><span class="n">IActivityManager</span><span class="o">},</span>
            <span class="k">new</span> <span class="n">ActivityManagerHandler</span><span class="o">(</span><span class="n">obj</span><span class="o">));</span>
    <span class="n">mInstanceField</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="n">gDefault</span><span class="o">,</span> <span class="n">proxy</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></div><p>就是要获取 gDefault 这个值，这是个 SingleTon&lt; IActivityManager &gt;，IActivityManager 这里其实是 AMP，我们通过反射将其设置成为我们的代理对象,并且把原始对象传入，然后自己处理具体的过程。</p>
</li>
<li>
<p>AcitivityManagerHandler 主要代码</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java">      <span class="n">Intent</span> <span class="n">intent</span><span class="o">;</span>
      <span class="kt">int</span> <span class="n">index</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span>
      <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">objects</span><span class="o">.</span><span class="na">length</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
          <span class="k">if</span> <span class="o">(</span><span class="n">objects</span><span class="o">[</span><span class="n">i</span><span class="o">]</span> <span class="k">instanceof</span> <span class="n">Intent</span><span class="o">)</span> <span class="o">{</span>
              <span class="n">index</span> <span class="o">=</span> <span class="n">i</span><span class="o">;</span>
              <span class="k">break</span><span class="o">;</span>
          <span class="o">}</span>
      <span class="o">}</span>
      <span class="n">intent</span> <span class="o">=</span> <span class="o">(</span><span class="n">Intent</span><span class="o">)</span> <span class="n">objects</span><span class="o">[</span><span class="n">index</span><span class="o">];</span>
      <span class="n">Intent</span> <span class="n">newIntent</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Intent</span><span class="o">();</span>
      <span class="n">String</span> <span class="n">subPackageName</span> <span class="o">=</span> <span class="n">MyApplication</span><span class="o">.</span><span class="na">getContext</span><span class="o">().</span><span class="na">getPackageName</span><span class="o">();</span>
      <span class="n">ComponentName</span> <span class="n">componetName</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ComponentName</span><span class="o">(</span><span class="n">subPackageName</span><span class="o">,</span> <span class="n">ZhanKeng</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getName</span><span class="o">());</span>
      <span class="n">newIntent</span><span class="o">.</span><span class="na">setComponent</span><span class="o">(</span><span class="n">componetName</span><span class="o">);</span>
      <span class="n">newIntent</span><span class="o">.</span><span class="na">putExtra</span><span class="o">(</span><span class="s">&#34;real_intent&#34;</span><span class="o">,</span> <span class="n">intent</span><span class="o">);</span>
      <span class="n">objects</span><span class="o">[</span><span class="n">index</span><span class="o">]</span> <span class="o">=</span> <span class="n">newIntent</span><span class="o">;</span>
      <span class="n">Log</span><span class="o">.</span><span class="na">e</span><span class="o">(</span><span class="s">&#34;Main&#34;</span><span class="o">,</span> <span class="s">&#34;startActivity方法 hook 成功&#34;</span><span class="o">);</span>
      <span class="n">Log</span><span class="o">.</span><span class="na">e</span><span class="o">(</span><span class="s">&#34;Main&#34;</span><span class="o">,</span> <span class="s">&#34;args[index] hook = &#34;</span> <span class="o">+</span> <span class="n">objects</span><span class="o">[</span><span class="n">index</span><span class="o">]);</span>
      <span class="k">return</span> <span class="n">method</span><span class="o">.</span><span class="na">invoke</span><span class="o">(</span><span class="n">mBase</span><span class="o">,</span> <span class="n">objects</span><span class="o">);</span>
</code></pre></div><p>这里主要就是先找到 Intent 参数，然后替换成 ZhanKeng 这个 Acitivity,再把我们自己真正要启动的 acitivity 信息存储在新的 Intent中</p>
</li>
<li>
<p>Handler 的 hook</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">private</span> <span class="kt">void</span> <span class="nf">handlerHook</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
   <span class="n">Class</span> <span class="n">ActivityThread</span> <span class="o">=</span> <span class="n">Class</span><span class="o">.</span><span class="na">forName</span><span class="o">(</span><span class="s">&#34;android.app.ActivityThread&#34;</span><span class="o">);</span>
   <span class="n">Method</span> <span class="n">currentActivityThread</span> <span class="o">=</span> <span class="n">ActivityThread</span><span class="o">.</span><span class="na">getDeclaredMethod</span><span class="o">(</span><span class="s">&#34;currentActivityThread&#34;</span><span class="o">);</span>
   <span class="n">currentActivityThread</span><span class="o">.</span><span class="na">setAccessible</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
   <span class="n">Object</span> <span class="n">ActivityThreadInstance</span> <span class="o">=</span> <span class="n">currentActivityThread</span><span class="o">.</span><span class="na">invoke</span><span class="o">(</span><span class="kc">null</span><span class="o">);</span>
   <span class="n">Field</span> <span class="n">mH</span> <span class="o">=</span> <span class="n">ActivityThread</span><span class="o">.</span><span class="na">getDeclaredField</span><span class="o">(</span><span class="s">&#34;mH&#34;</span><span class="o">);</span>
   <span class="n">mH</span><span class="o">.</span><span class="na">setAccessible</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
   <span class="n">Handler</span> <span class="n">H</span> <span class="o">=</span> <span class="o">(</span><span class="n">Handler</span><span class="o">)</span> <span class="n">mH</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">ActivityThreadInstance</span><span class="o">);</span>
   <span class="n">Field</span> <span class="n">mCallBackField</span> <span class="o">=</span> <span class="n">Handler</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getDeclaredField</span><span class="o">(</span><span class="s">&#34;mCallback&#34;</span><span class="o">);</span>
   <span class="n">mCallBackField</span><span class="o">.</span><span class="na">setAccessible</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
   <span class="n">mCallBackField</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="n">H</span><span class="o">,</span> <span class="k">new</span> <span class="n">ActivityThreadHandlerCallBack</span><span class="o">(</span><span class="n">H</span><span class="o">));</span>
<span class="o">}</span>
</code></pre></div><p>前面说过，当我们 hook 了 AMS 之后，换了 Intent 通过了检查，但是我们在最后真正启动的时候还要把我们真正的 Intent 再拿出来，不然启动的就是宿主的占坑 Activity 了。这里我们就是通过反射拿到了 H 这个 Handler 并且给这个 Handler 设置了一个 Callback，根据 Handler 的源码可以知道，如果一个 Handler 存在一个 Callback 那么要先执行其 Callback 方法。我们自己写一个 callback 把 H 中的 callback 替换掉。</p>
</li>
<li>
<p>ActivityThreadHandlerCallBack</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">handleMessage</span><span class="o">(</span><span class="n">Message</span> <span class="n">msg</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">Log</span><span class="o">.</span><span class="na">e</span><span class="o">(</span><span class="s">&#34;Main&#34;</span><span class="o">,</span><span class="s">&#34;handleMessage what = &#34;</span> <span class="o">+</span> <span class="n">msg</span><span class="o">.</span><span class="na">what</span><span class="o">);</span>
    <span class="k">switch</span> <span class="o">(</span><span class="n">msg</span><span class="o">.</span><span class="na">what</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// ActivityThread里面 &#34;LAUNCH_ACTIVITY&#34; 这个字段的值是100
</span><span class="c1"></span>        <span class="c1">// 本来使用反射的方式获取最好, 这里为了简便直接使用硬编码
</span><span class="c1"></span>        <span class="k">case</span> <span class="n">100</span><span class="o">:</span>
            <span class="n">handleLaunchActivity</span><span class="o">(</span><span class="n">msg</span><span class="o">);</span>
            <span class="k">break</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="n">mBase</span><span class="o">.</span><span class="na">handleMessage</span><span class="o">(</span><span class="n">msg</span><span class="o">);</span>
    <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
<span class="o">}</span>

<span class="kd">private</span> <span class="kt">void</span> <span class="nf">handleLaunchActivity</span><span class="o">(</span><span class="n">Message</span> <span class="n">msg</span><span class="o">)</span> <span class="o">{</span>
    <span class="c1">// 这里简单起见,直接取出TargetActivity;
</span><span class="c1"></span>    <span class="n">Log</span><span class="o">.</span><span class="na">e</span><span class="o">(</span><span class="s">&#34;Main&#34;</span><span class="o">,</span><span class="s">&#34;handleLaunchActivity方法 拦截&#34;</span><span class="o">);</span>
    <span class="n">Object</span> <span class="n">obj</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="na">obj</span><span class="o">;</span>
    <span class="k">try</span> <span class="o">{</span>
        <span class="c1">// 把替身恢复成真身
</span><span class="c1"></span>        <span class="n">Field</span> <span class="n">intent</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="na">getClass</span><span class="o">().</span><span class="na">getDeclaredField</span><span class="o">(</span><span class="s">&#34;intent&#34;</span><span class="o">);</span>
        <span class="n">intent</span><span class="o">.</span><span class="na">setAccessible</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
        <span class="n">Intent</span> <span class="n">raw</span> <span class="o">=</span> <span class="o">(</span><span class="n">Intent</span><span class="o">)</span> <span class="n">intent</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">obj</span><span class="o">);</span>

        <span class="n">Intent</span> <span class="n">target</span> <span class="o">=</span> <span class="n">raw</span><span class="o">.</span><span class="na">getParcelableExtra</span><span class="o">(</span><span class="n">AMSHookHelper</span><span class="o">.</span><span class="na">EXTRA_TARGET_INTENT</span><span class="o">);</span>
        <span class="n">raw</span><span class="o">.</span><span class="na">setComponent</span><span class="o">(</span><span class="n">target</span><span class="o">.</span><span class="na">getComponent</span><span class="o">());</span>
        <span class="n">Log</span><span class="o">.</span><span class="na">e</span><span class="o">(</span><span class="s">&#34;Main&#34;</span><span class="o">,</span><span class="s">&#34;target = &#34;</span> <span class="o">+</span> <span class="n">target</span><span class="o">);</span>

    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="n">RuntimeException</span><span class="o">(</span><span class="s">&#34;hook launch activity failed&#34;</span><span class="o">,</span> <span class="n">e</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div><p>这里就是通过判断是不是 LAUNCH_ACTIVITY 来决定是不是我们自己处理，如果我们自己出力，那么就要记得把我们的 Intent 换回来！</p>
</li>
</ul>
</li>
</ul>
<h2 id="资源问题还没有解决">资源问题还没有解决</h2>
<p>通过上面一系列操作就可以调起来 Activity 了，但是没法引用资源，后面也会继续跟着学习有关资源问题的解决办法</p>
<h2 id="学习目标">学习目标</h2>
<p>把开源的插件化代码都看一看，看看他们到底是怎么处理的，兼容性和稳定性方面肯定比这个简陋的 demo 要强很多，而且还要支持四大组件！加油！</p>
<h2 id="参考">参考</h2>
<p>全都是对 <a href="https://github.com/ljqloveyou123/LiujiaqiAndroid" target="_blank" rel="noopener noreffer">LiujiaqiAndroid</a> 这个项目的学习，然后写出点总结，希望自己别忘记了这些！</p></div><div class="post-footer" id="post-footer">
    <div class="post-info">
        <div class="post-info-line">
            <div class="post-info-mod">
                <span>更新于 2017-10-18</span>
            </div>
            <div class="post-info-license"></div>
        </div>
        <div class="post-info-line">
            <div class="post-info-md"></div>
            <div class="post-info-share">
                <span></span>
            </div>
        </div>
    </div>

    <div class="post-info-more">
        <section class="post-tags"><i class="fas fa-tags fa-fw"></i>&nbsp;<a href="/tags/%E6%8F%92%E4%BB%B6%E5%8C%96/">插件化</a></section>
        <section>
            <span><a href="javascript:void(0);" onclick="window.history.back();">返回</a></span>&nbsp;|&nbsp;<span><a href="/">主页</a></span>
        </section>
    </div>

    <div class="post-nav"><a href="/posts/2017-09-26-Android-7.0-%E6%8A%93%E5%8C%85%E9%97%AE%E9%A2%98/" class="prev" rel="prev" title="Android 7.0 抓包问题"><i class="fas fa-angle-left fa-fw"></i>Android 7.0 抓包问题</a>
            <a href="/posts/2017-10-26-Activity-%E5%90%AF%E5%8A%A8%E8%BF%87%E7%A8%8B/" class="next" rel="next" title="Activity 启动过程">Activity 启动过程<i class="fas fa-angle-right fa-fw"></i></a></div>
</div>
<div id="comments"><div id="gitalk" class="comment"></div><noscript>
                Please enable JavaScript to view the comments powered by <a href="https://github.com/gitalk/gitalk"></a>Gitalk</a>.
            </noscript></div></article></div>
            </main><footer class="footer">
        <div class="footer-container"><div class="footer-line">由 <a href="https://gohugo.io/" target="_blank" rel="noopener noreffer" title="Hugo 0.81.0">Hugo</a> 强力驱动 | 主题 - <a href="https://github.com/dillonzq/LoveIt" target="_blank" rel="noopener noreffer" title="LoveIt 0.2.10"><i class="far fa-kiss-wink-heart fa-fw"></i> LoveIt</a>
                </div><div class="footer-line"><i class="far fa-copyright fa-fw"></i><span itemprop="copyrightYear">2019 - 2021</span><span class="author" itemprop="copyrightHolder">&nbsp;<a href="/" target="_blank"></a></span>&nbsp;|&nbsp;<span class="license"><a rel="license external nofollow noopener noreffer" href="https://creativecommons.org/licenses/by-nc/4.0/" target="_blank">CC BY-NC 4.0</a></span></div>
        </div>
    </footer></div>

        <div id="fixed-buttons"><a href="#" id="back-to-top" class="fixed-button" title="回到顶部">
                <i class="fas fa-arrow-up fa-fw"></i>
            </a><a href="#" id="view-comments" class="fixed-button" title="查看评论">
                <i class="fas fa-comment fa-fw"></i>
            </a>
        </div><link rel="stylesheet" href="/lib/gitalk/gitalk.min.css"><script type="text/javascript" src="/lib/gitalk/gitalk.min.js"></script><script type="text/javascript" src="/lib/smooth-scroll/smooth-scroll.min.js"></script><script type="text/javascript" src="/lib/autocomplete/autocomplete.min.js"></script><script type="text/javascript" src="/lib/algoliasearch/algoliasearch-lite.umd.min.js"></script><script type="text/javascript" src="/lib/lazysizes/lazysizes.min.js"></script><script type="text/javascript" src="/lib/clipboard/clipboard.min.js"></script><script type="text/javascript" src="/lib/typeit/typeit.min.js"></script><script type="text/javascript">window.config={"code":{"copyTitle":"复制到剪贴板","maxShownLines":10},"comment":{"gitalk":{"admin":["PTrain666"],"clientID":"2266a6b1be9e64aca6b8","clientSecret":"95a87d5d16492501b3629046e7d5689bb5f949bf","id":"2017-10-18T00:00:00Z","owner":"PTrain666","repo":"PTrain666.github.io","title":"插件化基础（简单调起 Activity）"}},"data":{"id-1":"北邙山之光的 Blog","id-2":"北邙山之光的 Blog"},"search":{"algoliaAppID":"DY3IPG94HO","algoliaIndex":"blog","algoliaSearchKey":"e9b70bb1815b657ef5122006a8a499b6","highlightTag":"em","maxResultLength":10,"noResultsFound":"没有找到结果","snippetLength":50,"type":"algolia"},"typeit":{"cursorChar":"|","cursorSpeed":1000,"data":{"id-1":["id-1"],"id-2":["id-2"]},"duration":-1,"speed":100}};</script><script type="text/javascript" src="/js/theme.min.js"></script></body>
</html>
